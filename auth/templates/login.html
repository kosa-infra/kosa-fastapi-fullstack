{% extends "base.html" %} {% block title %}로그인{% endblock %} {% block content
%}
<h2>로그인</h2>
<div id="message"></div>
<form id="loginForm" method="post" action="/auth/login">
  <input type="text" name="username" placeholder="아이디" required />
  <input type="password" name="password" placeholder="비밀번호" required />
  <button type="submit">로그인</button>
</form>

<script>
  document
    .getElementById("loginForm")
    .addEventListener("submit", async function (e) {
      e.preventDefault();

      const formData = new FormData(this);
      try {
        const response = await fetch("/auth/login", {
          method: "POST",
          body: formData,
        });

        if (response.ok) {
          const data = await response.json();
          localStorage.setItem("user", JSON.stringify(data));
          alert("로그인 성공! " + data.username);
          location.reload();
          window.location = "/dashboard";
          // fetch("/api/get-redirect", {
          //   method: "POST",
          //   headers: { "Content-Type": "application/json" },
          //   body: JSON.stringify(JSON.parse(localStorage.getItem("user"))),
          // }).then((response) => {
          //   if (response.redirected) {
          //     window.location.href = response.url;
          //   }
          // });
        } else {
          const errorData = await response.json().catch(() => ({}));
          alert("로그인 실패: " + (errorData.detail || "알 수 없는 오류"));
        }
      } catch (error) {
        alert("오류 발생: " + error.message);
      }
    });

  window.addEventListener("load", function () {
    const userData = localStorage.getItem("user");

    if (userData) {
      try {
        const user = JSON.parse(userData);
        if (user.isLogin) {
          const nav = document.querySelector("nav");
          if (nav) {
            nav.innerHTML =
              '<span style="color:green">안녕하세요, ' +
              user.username +
              "님!</span> | " +
              '<a href="#" onclick="localStorage.removeItem(\'user\'); location.reload(); return false;">로그아웃</a>';
          }
        }
      } catch (e) {
        console.error("localStorage 오류:", e);
      }
    }
  });
</script>
{% endblock %}
